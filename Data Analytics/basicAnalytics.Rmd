---
title: "Basic Data Analytics"
author: "Cameron Kline-Sharpe"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse=TRUE, prompt=TRUE,comment=NULL,message=FALSE, include=TRUE, fig.height = 4, fig.width = 8)
```


```{r getPackages, include=FALSE}
library(tidyverse)
```

# If you modify this code, please add your name to the top of the document, in the author section.

## TODO:

1. regroup asian, native american with Other for most things
2. For the sake of comparison with our algorithms, focus on making confusion matrix-like graphs
3. Colors often backwards--pick consistant colors; note also to provide colors with correct conotations (red==bad, blue==not)

```{r getData, include=FALSE}
# here we load in the COMPAS data set
# R's automatic loading feature gets the type of some of the data wrong, so those must be set manually 
COMPAS <- read_csv("../CleanedFeaturesData.csv", 
                   col_type = cols(person_id = col_integer(),
                                   age = col_integer(),
                                   juv_fel_count = col_integer(),
                                   juv_misd_count = col_integer(),
                                   juv_other_count = col_integer(),
                                   decile_score = col_integer(),
                                   priors_count = col_integer(),
                                   num_r_cases = col_integer(),
                                   num_vr_cases = col_integer(),
                                   is_recid = col_logical(),
                                   is_violent_recid = col_logical()))

# much of the data in CleanedFeaturesData.csv is not needed, so for the sake of speed
#    we use fewer features of the data
simple_COMPAS <- COMPAS %>% 
  select(person_id, age, race, decile_score, is_recid, is_violent_recid) %>% # get only these columns
  mutate(recidDist = ifelse(is_recid, 10-decile_score, decile_score-1),
         predict5 = ifelse(decile_score > 5, TRUE, FALSE)) %>%  # add a prediction column that predicts recidivism if the score exceeds 5
  filter(recidDist >= 0) %>% # remove all people who have an impossible distance
  mutate(recid = ifelse(is_recid, "Did Recidivate", "Did Not Recidivate"),
         predict5Corr = ifelse(predict5 == is_recid, "Correct", "Incorrect")) # add some strings to the data for ease of display


# read in the Decision tree data for recidivism
DT <- read_csv("DTPredictions.csv",
               col_type = cols(prediction = col_logical(), truth = col_logical())) %>%
      mutate(correct = ifelse(prediction == truth, "Correct", "Incorrect"),
             truthChar = ifelse(truth, "Did Recidivate", "Did Not Recidivate"))

# read in the Decision tree data for violent recidivism
DT_Violent <- read_csv("DTViolentPredictions.csv",
               col_type = cols(prediction = col_logical(), truth = col_logical())) %>% # get the data types right
      mutate(correct = ifelse(prediction == truth, "Correct", "Incorrect"),
             truthChar = ifelse(truth, "Did Violently Recidivate", "Did Not Violently Recidivate")) # again, some strings for ease of display


green <- "#5BB84C"
green2 <- "#4CB88F"
blue <- "#1FBFC3" 
red <- "#F57670"
redAlarm <- "#E82F16"
```


```{r compasError, echo=FALSE}

simple_COMPAS <- simple_COMPAS %>%
  mutate(pred5Status = ifelse(predict5, 
                              ifelse(is_recid, "True Positive", "False Positive"), 
                              ifelse(is_recid, "False Negative", "True Negative"))) %>% # get the TP, NP, etc.
  mutate(recidStatus = ifelse(is_recid, ifelse(is_violent_recid, "Violently Recidivated", "Did Recidivate"), "Did Not Recidivate")) 

# TODO: try pie chart (maybe just of those who recidivism)
ggplot(simple_COMPAS, aes(x = recidStatus, fill=recidStatus)) + 
  geom_bar() + 
  labs(title = "Reicidivism in our Training Data", x="Did they Recidivate?", fill="Did they Violently Recidivate?") + 
  scale_fill_manual(values = c(green, blue, red))


ggplot(simple_COMPAS, aes(x = recid, fill=recidStatus)) + 
  geom_bar() + 
  labs(title = "Reicidivism in our Training Data (Grouped)", x="Did they Recidivate?", fill="Did they Violently Recidivate?") + 
  scale_fill_manual(values = c(green, blue, red))

ggplot(simple_COMPAS) + 
  geom_bar(mapping = aes(x = recidDist), fill="darkBlue") + 
  labs(title="COMPAS Score Distances", x="COMPAS Score Distances")
  
  
ggplot(simple_COMPAS, aes(x = recidDist, fill=recidStatus)) + geom_bar() +
  facet_wrap(~recidStatus) + 
  labs(title="COMPAS Score Distances by Recidivism", x = "Score Distance", fill = "Recidivism") + 
  scale_fill_manual(values = c(green, blue, red))

# TODO: check that these are good colors
ggplot(simple_COMPAS, aes(x = pred5Status, fill=pred5Status)) +
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(title = "Confusion Matrix as a Bar Graph", x="Prediction Status") + 
  scale_fill_manual(values = c(red, redAlarm, green, green2))
```

### CONFUSION MATRIX
  Confusion Matrix | Score > 5 | Score <= 5 |
------------------ | --------- | ---------- |
Did Recidivate     |   5333    | 1993       |
Did not Recidivate |   1794    | 1909       |


```{r race, echo = FALSE}


simple_COMPAS <- simple_COMPAS %>%
  mutate(race2 = ifelse(race %in% c("Asian", "Native American"), "Other", race))

ggplot(simple_COMPAS, aes(x=race2, fill=is_recid)) + 
  geom_bar() + 
  labs(title = "Proportion of Recidivism by Race (Grouped) [Compare with Previous]", x="Grouped Race", y="Number", fill="Recidivism")

ggplot(simple_COMPAS, aes(x=race, fill=recidStatus)) + 
  geom_bar() + 
  labs(title = "Proportion of Recidivism by Race", x="Race", y="Number", fill="Recidivism") + 
  scale_fill_manual(values = c(green, blue, red)) 

ggplot(simple_COMPAS, aes(x=race2, fill=is_recid)) + 
  geom_bar() + 
  labs(title = "Proportion of Recidivism by Race (Grouped)", x="Grouped Race", y="Number", fill="Recidivism")

ggplot(simple_COMPAS, aes(x=race2, fill=recidStatus)) + 
  geom_bar() + 
  labs(title = "Proportion of Recidivism by Race (Grouped) [Compare with Previous]", x="Grouped Race", y="Number", fill="Recidivism") + 
  scale_fill_manual(values = c(green, blue, red)) 

ggplot(simple_COMPAS, aes(x=race2, y=decile_score, color = race2)) + 
  geom_boxplot() + 
  labs(title = "COMPAS Decile Score by Race", y="Decile Score", x="Race (Grouped)", color="Race") + 
  stat_summary(fun.y = mean, geom="point", shape = 22)

ggplot(simple_COMPAS, aes(x=race2, color=race2, y=recidDist)) + 
  geom_boxplot() + 
  labs(title="COMPAS Score Distance by Race", y="Distance", x="Race (Grouped)") + 
  stat_summary(fun.y = mean, geom="point", shape = 22)

simple_COMPAS %>%
  ggplot(mapping = aes(x=race, y=recidDist, color=recid)) + 
    geom_boxplot() + 
    labs(title="Compas Score Distance by Race and Recidivism", y="Distance", x="Race (Grouped)")
```

```{r age, echo=FALSE}
by_age <- simple_COMPAS %>% 
  group_by(age) %>%
  summarise(numRecid=sum(is_recid), numViolent=sum(is_violent_recid), n=n()) %>%
  gather(2:4, key = metric, value = n)

ggplot(by_age, aes(x = age, y = n, color = metric)) + 
  geom_path() + 
  labs(title = "Number of People by Age", x = "Age", y="Count")


ggplot(simple_COMPAS, aes(x=age, y=recidDist)) + 
  geom_smooth() +
  labs(title = "COMPAS Score Distance by Age", y = "COMPAS Score Distance")

ggplot(simple_COMPAS, aes(x=age, y=recidDist, color=recidStatus)) + 
  geom_smooth() +
  labs(title = "COMPAS Score Distance by Age and Recidivism", y = "COMPAS Score Distance") + 
  scale_color_manual(values = c(green, blue, red)) 

```


```{r DT, echo=FALSE}


simple_COMPAS %>%
  mutate(recid = ifelse(is_recid, "Did Recidivate", "Did Not Recidivate"),
         predict5Corr = ifelse(predict5 == is_recid, "Correct", "Incorrect")) %>%
  ggplot( aes(x=recid, fill=predict5Corr)) + 
    geom_bar() + 
    scale_fill_manual(values = c("#1FBFC3", "#F57670")) + 
    labs(title="COMPAS Confusion Matrix as a Bar Graph", fill="COMPAS Prediction")

ggplot(DT, aes(x = truthChar, fill=correct)) + 
  geom_bar() +
  labs(title = "Decision Tree Confusion Matrix as Bar Graph", fill="DT Prediction") + 
  scale_fill_manual(values = c("#1FBFC3", "#F57670")) 
  
ggplot(DT_Violent, aes(x = truthChar, fill=correct)) + 
  geom_bar() +
  labs(title = "Decision Tree Confusion Matrix for Violent Recidivism as a Bar Graph", fill="DT Prediction", x = "Ground Truth") + 
  scale_fill_manual(values = c("#1FBFC3", "#F57670"))
  

```
















